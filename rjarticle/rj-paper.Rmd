---
title: "corVis: An R Package for Visualising Associations and Conditional Associations"
abstract: >
 We present \CRANpkg{corVis}, an R package for visualizing association and conditional association using measures of association. The package provides matrix and linear layout for displaying bivariate association possibly  grouped by levels of a categorical variable, using measures suitable for numerical, ordinal and nominal variables. With these displays, an analyst can gain an  overview about the interesting structure and underlying patterns in the data. We provide a detailed look at the package functions and discuss the implemented design choices. We also provide an illustration of the package on an example dataset.
draft: true
author:  
  
  - name: Amit Chinwan
    affiliation: Maynooth University
    address:
    - Hamilton Institute
    - Maynooth, Ireland
    email:  amit.chinwan.2019@mumail.ie
  - name: Catherine Hurley
    email: catherine.hurley@mu.ie
    affiliation: Maynooth University
    address:
    - Department of Mathematics and Statistics
    - Maynooth, Ireland
type: package
output: 
  rjtools::rjournal_web_article:
    self_contained: yes
    toc: no
bibliography: RJreferences.bib
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(corVis)
library(palmerpenguins)
library(ggplot2)
library(dplyr)
library(kableExtra)
library(magrittr)
```

# Introduction

The first stage in data analysis includes exploring numerical and graphical variable summaries.
Correlation matrix displays are useful for showing bivariate associations. Generally these show Pearson's correlation, a measure of linear association for pairs of numerical variables. Alternative measures are needed to capture complex non-linear associations, and associations involving categorical variables.
In addition, correlation displays commonly use a matrix layout which require a lot of space for  high-dimensional datasets.

In this paper, we introduce the R package \CRANpkg{corVis} which addresses the limitations of existing correlation matrix displays. 
As most datasets are a mix of numerical, ordinal and categorical variables, 
we provide association measures for pairs of numerical, ordinal and categorical variables. We also provide measures for mixed pairs of variables, where one variable is categorical and the other is numerical. 
For numerical variables, we include measures of non-linear association such as distance correlation [@szekely2007measuring] and the maximal information coefficient (MIC) [@reshef2011detecting]].
We provide a new tibble data structure for (possibly multiple) association measures for each pair of variables. The data structure is also used for pairwise association measures for levels of a grouping variable.


In \CRANpkg{corVis} the association measures are displayed using two different layouts. Our first display uses a matrix-layout, similar to existing correlation matrix displays. A novel feature is that our version can show multiple association measures for each pair of variables so that patterns other than linear association, or association that depends on the level of a grouping variable, become evident.  For high-dimensional datasets, matrix layouts become unwieldy and run out of space, so our second display uses a linear layout, showing one or more association measures for each pair of variables. This is especially useful when the analyst wishes to limit the display to pairs of variables showing non-negligible associations.
Following @friendly2002corrgrams who employed ordered correlation displays enabling quick identification of  groups of variables with high mutual correlation, we use seriation for matrix displays and importance sorting for linear displays. In both cases the goal is to place  highly-associated variables or variable pairs with high differences in prominent locations so they become  easier to identify. 



The next section provides a review of existing packages which deal with correlation displays and a background on association measures and the packages used for calculating them. Then we describe our approach to calculating the association measures, followed by illustrations of the proposed displays. We conclude with a discussion and future work.

# Background

In this section, we provide a brief review of some of the association measures used in the package \CRANpkg{corVis} and the existing packages used for correlation displays.

## Association Measures

An association measure is defined as a numerical summary quantifying the relationship between two or more variables. The measure is symmetric if its value is invariant to the order of inputs. For example, Pearson’s correlation coefficient is a symmetric measure with a value in the range  [−1,1] summarising  the strength and direction of the linear relationship  between two numeric variables. Similarly, Kendall’s and Spearman’s rank correlation coefficients  are symmetric measures assessing monotonic association between numeric variables. This section starts with a review of the association measures for numeric pairs, followed by measures for nominal/ordinal pairs and then finally measures suitable for mixed variable pairs.

Because Pearson's correlation is a measure of linear dependence only, it misrepresents relationships that aren't linear and makes it a less useful measure. The recently developed measures such as distance correlation [@szekely2007measuring] and MIC [@reshef2011detecting] overcome this limitation and are more suitable for datasets with both linear and non-linear patterns.

The distance correlation coefficient is a symmetric measure with its value in $[0,1]$ and summarizes any relationship between two numeric variables using the distances between observations of these variables. The distance correlation is $0$ if and only if the variables are independent and $1$ when the variables are perfectly linear. The R package \CRANpkg{energy} [@energy] implements distance correlation.

The maximal information coefficient (MIC) is an information theory measure which uses mutual information among the two variables for its calculation. The main idea is to find a grid out of possible grids on a scatterplot of two numeric variables, in order to discretize the variables, which maximises the mutual information. A normalisation technique is used to make the mutual information from different grids comparable. Referred to as 'a correlation of 21st century' [@speed2011correlation], MIC is capable of summarizing different types of relationships, not just linear or monotonic, between numeric variables and is in the interval $[0,1]$. MIC is a symmetric measure where a zero value indicates independence among the variables and a value of 1 represents a  noiseless functional relationship. @reshef2011detecting used MIC and other related statistics to explore pairwise relationships in large data sets such as major-league baseball, gene expression, global health, and the human gut microbiota. The MIC and related maximal information based non parametric exploration statistics have been implemented in the R package \CRANpkg{minerva} [@minerva].

@commentSimonTibshirani simulated pairs of variables with different relationships at varying levels of noise and showed that distance correlation has more statistical power than MIC. @kinney2014equitability showed that MIC is not equitable and its values might not be affected by variable noise for certain relationships. They also note that MIC could have a value of 1.0 for differing noise levels. 

The alternating conditional expectations (ACE) algorithm [@breiman1985estimating] estimates optimal transformations between response and predictor variables during the regression analysis. For numeric variable pairs, the algorithm calculates the maximal correlation coefficient among the transformed variables and summarizes the non-linear relationship between them. It is a symmetric measure and takes a value in interval $[0,1]$. It is equal to zero if and only if the variables are independent. The R package \CRANpkg{acepack} [@acepack] provides an implementation of ACE algorithm.

For nominal variable pairs, measures such as Pearson's contingency coefficient and Uncertainty coefficient [@theil1970estimation] are used to quantify the association. Pearson's contingency coefficient is a symmetric measure which uses the ${\chi}^2$ value from Pearson's ${\chi}^2$ test for independence and is scaled in the interval $[0,1]$. The uncertainty coefficient [@theil1970estimation] measures the proportion of uncertainty in one variable which is explained by the other. The uncertainty coefficient is in the range $[0,1]$ and is not symmetric. A symmetric version is used by taking the mean of the uncertainty coefficients obtained by treating each variable as an independent variable once. Both the measures have been provided in the R package \CRANpkg{DescTools} [@DescTools].

@agresti2010analysis provides an overview of the measures which are used for exploring the association between ordinal variables. Kendall's tau-b [@kendall1945treatment] is a measure of the strength and direction of the association between two ordinal variables. It is based on the number of concordances and discordances in paired observations of the variables and summarizes the association in the range $[-1,1]$. The polychoric correlation [@olsson1979maximum] measures the correlation between two ordinal variables by assuming two normally distributed latent variables and summarizes the association in $[-1,1]$. Both Kendall's tau-b and polychoric correlation are symmetric and are available in the R packages \CRANpkg{DescTools} [@DescTools] and \CRANpkg{polycor} [@polycor].

Normalized mutual information (NMI) is a useful measure to summarise the association for mixed variable pairs. The package \CRANpkg{linkspotter} provides an implementation of Maximal Normalized Mutual Information for different variable pairs. The numeric variables are first discretized and then used for calculating mutual information. We use this measure for numeric, nominal and mixed pairs in \CRANpkg{corVis}. Canonical correlation is used to assess relationships for mixed variable pairs by converting nominal variables into sets of dummy variables, which are then assigned scores to find the maximal correlation. For two numeric variables, this measure is identical to absolute correlation, for two factors the correlation is identical to that obtained from correspondence analysis. We provide implementation of canonical correlation in \CRANpkg{corVis}.

In \CRANpkg{corVis}, we provide multiple association measures which can discover non-linear patterns and interesting associations featuring categorical variables.


## Correlation Displays

According to @hills1969looking, "the first and sometimes only impression gained by looking at a large correlation matrix is its largeness". To overcome this, @murdoch1996graphical proposed a  display for large correlation matrices which uses a matrix layout of ellipses where the parameters of the ellipses are scaled to the correlation values. @friendly2002corrgrams  expanded on this idea by rendering correlation values as shaded squares, bars, ellipses, or circular ‘pac-man’ symbols.

```{r corrdisplay-packages,warning=FALSE,message=FALSE,echo=FALSE }
library(kableExtra)

Package <- c("corrplot","mbgraphic","corrr","corrgrapher","linkspotter",  "correlation","corVis")

Display <- c("heatmap","heatmap","heatmap/network","network","network","heatmap/network","heatmap/matrix/linear")


MixedVariables <- c(" "," "," "," ","Yes"," ","Yes")



df <- data.frame(Package=Package,
                 Display=Display,
                 MixedVariables=MixedVariables)

kableExtra::kbl(df, booktabs = T, caption = "List of the R packages dealing with correlation or correlation displays with information on whether the plots display multiple measures, conditional display of measures and mixed variables in a single plot")
#print(table_1)
#df %>%
  #kbl() %>%
  #kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

Nowadays, there are many R  packages devoted to correlation visualisation. Table \@ref(tab:corrdisplay-packages) provides a summary, listing the displays offered, and whether these extend to factor variables or mixed numeric-factor pairs.  

The R package \CRANpkg{corrplot} [@corrplot2021] provides an implementation of the methods in @friendly2002corrgrams and produces displays in a matrix layout. The package \CRANpkg{corrr} [@corrr2020] organises correlations as tidy data first, so leveraging the data manipulation and visualisation tools of the \CRANpkg{tidyverse} [@tidyverse], which then can be displayed in a matrix format. @friendly2002corrgrams also focused on ordering of the variables for correlation displays where the variables were ordered using the angular ordering of the first two eigen vectors of the correlation matrix. The ordering places highly-correlated pairs of variables nearby, making it easier to quickly identify groups of variables with high mutual correlation. The package \CRANpkg{corrplot} [@corrplot2021] provides various ordering techniques for matrix displays along with the method implemented in @friendly2002corrgrams. @grimm2017kennzahlenbasierte in the package \CRANpkg{mbgraphic} explored correlation structure of numeric variables using interactive matrix displays. She extended the display to general measures like scagnostics, which are measures characterizing a scatterplot, along with two more measures, based on smoothing splines and distance correlation.

The package \CRANpkg{corrgrapher} [@corrgrapher] uses a network plot for exploring correlations, where the nodes close to each other have high correlation magnitude, edge thickness encodes the absolute correlation value and edge color indicates the sign of correlation. The package also handles mixed type variables by using association measures obtained as transformations of $p$-values obtained from Pearson's correlation test in the case of two numeric variables, Kruskal's test for numerical and factor variables, and a chi-squared test for two categorical variables. The package \CRANpkg{corrr} [@corrr2020] also offers network displays where line-thickness encodes correlation magnitude, with a filtering option to discard low-correlation edges. Another package for plotting correlations in a network layout is \CRANpkg{linkspotter} [@linkspotter] which offers a variety of association measures (distance correlation, MIC, maximum normalized mutual information) in addition to correlation, where the measure used depends on whether the variables are both numerical, categorical or mixed. The results are visualized in a network plot, which may be packaged into an interactive shiny application.

The R package \CRANpkg{correlationfunnel} offers a novel linear display which assists in feature selection in a setting with a single response and many predictor variables. All numeric variables including the response are binned. All (now categorical) variables in the resulting dataset are one-hot encoded and Pearson's correlation calculated with the response categories. The correlations are visualised in a dot-plot display, where predictors are ordered by maximum correlation magnitude. Correlations between one-hot encoded variables are challenging to interpret, especially as the number of levels increase.  In corVis we offer a similar dot-plot display, but showing multiple correlation or association measures, or alternatively measures stratified by a grouping variable.

Our own package \CRANpkg{corVis} offers a variety of displays, and has new features not available elsewhere, in particular simultaneous display of multiple association measures, and association displays stratified by levels of a grouping variable. This will be described  in the following sections.

<!-- @friendly2002corrgrams also focused on ordering of the variables for correlation displays where the variables were ordered using the angular ordering of the first two eigen vectors of the correlation matrix. The ordering places highly-correlated pairs of variables nearby, making it easier to quickly identify groups of variables with high mutual correlation. The package \CRANpkg{corrplot} [@corrplot2021] provides various ordering techniques for matrix displays along with the method implemented in @friendly2002corrgrams. -->


<!-- There have been other extensions to correlation displays which are useful when dealing with high dimensional datasets.  -->
<!-- @hills1969looking proposed a QQ plot of the $z$-transform of the entries of the correlation matrix to discover correlation coefficients too large to come from a normal distribution with mean zero. @buja2016visualization proposed Association Navigator which is an interactive visualization tool for large correlation matrices with upto 2000 variables.  The R package \CRANpkg{scorrplot} [@scorr] produces an interactive scatterplot for exploring pairwise correlations in a large dataset by projecting variables as points on a scatterplot with respect to some user-selected variables of interest, driven by a geometric interpretation of correlation and encoding the correlation as vertical gridlines in the plot. The package allows user to update variable of interest which creates tour of the correlation space between different projections of the data.  -->



# Overview of `corVis`

The R package \CRANpkg{corVis} offers a flexible framework to investigate and visualise associations using measures of association, in datasets with mixed variable types. The calculation and visualisation of association measures are carried out separately in \CRANpkg{corVis}, making it an open-ended package for both data structure and display of association measures. This allows users to leverage the widely used \CRANpkg{tidyverse} and \CRANpkg{ggplot2} framework for exploring these data structures.


In\CRANpkg{corVis}, we extend existing correlation displays beyond numeric variables by including mixed variable types and propose displays for multiple association measures useful for uncovering non-linear patterns or associations depending on the levels of a grouping variable. While designing these displays we consider matrix and linear layouts. Linear layouts are useful for high-dimensional datasets and allow a user to limit the display to variable pairs showing strong associations. We also order these displays so that the variable pairs with a strong association or a high difference in measures are placed at prominent positions. 

```{r function-corVis,warning=FALSE,message=FALSE,echo=FALSE }
library(kableExtra)

Function <- c("calc_assoc","calc_assoc_all","plot_assoc_matrix","plot_assoc_linear",
              "show_assoc")

Usage <- c("Calculation","Calculation","Visualization","Visualization",
           "Visualization")

#Usage <- c(rep("Calculation",5),rep("Visualization",3),rep("Visualization",5),rep("Visualization",4),rep("Visualization",5))

Description <- c("Calculates association measures",
                 
                 "Calculates all the association measures available in package",
                 
                 "Visualize assocition and conditional association in matrix plot",
                 
                 "Visualize assocition and conditional association in linear plot",
                 
                 "Association (or conditional) plot for a pair of variables")


df <- data.frame(Function=Function,
                 Usage=Usage,
                 Description=Description)

kableExtra::kbl(df,booktabs = T, caption = "List of functions in corVis package") %>%
  kableExtra::column_spec(1, bold=T)


  #kableExtra::collapse_rows(columns = 1:2)

#print(table_1)
#df %>%
  #kbl() %>%
  #kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

Table \@ref(tab:function-corVis) provides a list of the functions available in the package. The functions `calc_assoc` and `calc_assoc_all` are responsible for calculating association measures which are used as input for the `plot_assoc_matrix` and `plot_assoc_linear` functions. The functions `plot_assoc_matrix` and `plot_assoc_linear ` produces association display, multiple association measures display and conditional association display, in a matrix and linear layout respectively. We provide detailed examples on calculation and visualisation of association and conditional association in next sections.

## Example: Data

We use the Daily Bike Sharing dataset [@bikeref] from the R package \CRANpkg{timetk} [@timetk] which contains daily count of rental bike transactions between years 2011 and 2012 in Capital bikeshare system. The dataset also includes corresponding daily weather information such as humidity, temperature and windspeed, and seasonal information such as season, whether the day is a holiday and whether the day is a working day.

```{r bikedata,warning=FALSE,message=FALSE,echo=FALSE }
library(kableExtra)
library(timetk)
bike <- bike_sharing_daily[,-1] |>
  mutate(season= recode_factor(season,
                               `1`="Winter", `2`="Spring", `3`="Summer", `4`="Fall"),
         weathersit= recode_factor(weathersit, 
                         `1`="clear", `2`="cloudy", `3`="lightP", `4`="heavyP"),
         holiday=recode_factor(holiday, `0` = "No", `1`="Yes"),
         workingday = recode_factor(workingday, `0` = "No", `1`="Yes"),
         yr = recode_factor(yr,`0` = 2011, `1`=2012),
         weekday = recode_factor(weekday,`0` = "sun", `1` = "mon", `2`="tue", `3` = "wed", `4`="thu", `5`="fri", `6`="sat"),
         mnth = factor(month.abb[mnth], levels=month.abb)
         )
levels(bike$weathersit)<- rev(levels(bike$weathersit))

variable <- names(bike)

description <- c("date",
                 "season with categories Winter, Spring, Summer and Fall",
                 "year of day with categories 2011 and 2012",
                 "month of day with months as categories",
                 "whether day is a holiday or not",
                 "day of the week",
                 "if day is neither weekend nor holiday it is Yes, otherwise is No",
                 "weather situation of the day with categories clear, cloudy, lightP",
                 "normalized temperature in Celsius",
                 "normalized feeling temperature in Celsius",
                 "normalized humidity",
                 "normalized windspeed",
                 "count of casual users",
                 "count of registered users",
                 "count of total rental bikes including both casual and registered")

variable_type <- c("date","nominal","nominal","nominal","nominal","nominal","nominal","nominal","numeric","numeric","numeric","numeric","numeric","numeric","numeric")

df <- data.frame(Variable=variable,
                 Description=description,
                 VariableType=variable_type
                 )

kableExtra::kbl(df, booktabs = T, caption = "Variable description of the Daily Bike Sharing dataset") |>
  kableExtra::kable_styling(latex_options = "scale_down")
#print(table_1)
#df %>%
  #kbl() %>%
  #kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

Table \@ref(tab:bikedata) provides a brief description of Daily Bike Sharing data along with the types of variables present in the dataset. We use the dataset throughout this paper for illustrative usage of the package.


## Data Structures

We provide three tidy data structures which are explored using functions in \CRANpkg{corVis} or can be manipulated or visualized by leveraging tools in \CRANpkg{tidyverse} These data structures are: `pairwise`, `multi_pairwise` and `cond_pairwise`. Here, we provide an example of these three data structures along with how they are beneficial when used in the \CRANpkg{tidyverse} environment.

The `pairwise` data structure is a data format which contains scores for pairs of variables in a dataset for which a specified measure is defined. For example, the function `tbl_dcor` calculates the distance correlation measure for every numeric variable pair in the dataset. Each row of the `pairwise` object is characterized by the variable pair and association measure type.

```{r, pairwise-example,echo=TRUE}
# a subset of bike dataset
bike_s <- bike |> 
  dplyr::select(temp, windspeed, registered,weathersit, workingday)
dcor_bike <- tbl_dcor(bike_s)
dcor_bike
class(dcor_bike)
```


We define a `multi_pairwise` data structure as a data format which consists of multiple scores for variable pairs in the dataset. Similar to the `pairwise` object, every row of the `multi_pairwise` object is defined by the variable pair and measure type. An analyst interested in finding how different the association measure values are for each pair can use this object with \CRANpkg{tidyverse} tools to find the range of measures.

```{r,multipairwise-example,echo=TRUE}
multi_bike <- calc_assoc_all(bike_s,
                                 c("pearson","nmi","ace","uncertainty"))
class(multi_bike)

# calculating range of measures
multi_bike |> 
  group_by(x,y) |>
  summarise(range=max(measure)-min(measure),.groups = "drop") |>
  arrange(desc(range))
```


The final data structure in \CRANpkg{corVis} is `cond_pairwise` which contains scores for every variable pair at different levels of a conditioning variable. In this case, each row is uniquely identified by a variable pair and a level of the conditioning variable. For exploring pairwise differences in groups, an analyst can easily use data manipulation tools available in \CRANpkg{tidyverse} ecosystem.

```{r,condpairwise-example,echo=TRUE}
cond_bike <- calc_assoc(bike_s,
                            by="weathersit")
class(cond_bike)

# calculating difference in the group
cond_bike |> 
  group_by(x,y) |>
  summarise(diff=max(measure)-min(measure),.groups = "drop") |>
  arrange(desc(diff))

```

It is worth noting that both `multi_pairwise` and `cond_pairwise` objects inherit the `pairwise` class and satisfies the definition of the `pairwise` data structure. 

<!-- which are useful for calculating association measures among variable pairs and visualising these associations using novel displays. Section 4 provides a detailed description on functions used for calcuating association measures in the package. Section 5 illustrates the use of visualising functions in table \@ref(tab:function-corVis) for displaying pairwise association and conditional association. -->



 

# corVis: Calculating Association Measures

For exploring associations using \CRANpkg{corVis}, the first step is to calculate association measures for variable pairs in a dataset. Table \@ref(tab:association-measures) lists the functions provided in the package to calculate measures of association along with the information on the type of variable pairs they can be applied with. It also includes details about the external package functions used to calculate and the range for these measures. The association measures available in \CRANpkg{corVis} are symmetric. We convert asymmetric measures to symmetric ones by taking either the mean or the maximum of the measures calculated by treating each variable from the pair as an independent variable. The functions `tbl_ace` and `tbl_cancor` which calculate the maximal correlation coefficient among the transformed variables and canonical correlation respectively have been implemented in \CRANpkg{corVis}.


```{r association-measures,echo=FALSE}
measures <- dplyr::tribble(
  ~name, ~nn, ~ff, ~oo, ~nf, ~from, ~range,
  "tbl_cor", "y", " ", " " ," ", "stats::cor", "[-1,1]",
  "tbl_dcor", "y", " ", " ", " ", "energy::dcor2d", "[0,1]",
  "tbl_mine", "y", " ", " ", " ", "minerva::mine", "[0,1]",
  "tbl_ace", "y", "y", " ", "y", "corVis", "[0,1]",
  "tbl_cancor", "y", "y", " ","y", "corVis", "[0,1]",
  "tbl_nmi",  "y", "y", " ", "y", "linkspotter::maxNMI", "[0,1]",
  "tbl_polycor", " ", " ","y", " ", "polycor::polychor", "[-1,1]",
  "tbl_tau", " ", " ","y", " ", "DescTools::KendalTauA,B,C,W", "[-1,1]",
  "tbl_gkGamma", " ", " ", "y", " ", "DescTools::GoodmanKruskalGamma", "[-1,1]",
  "tbl_gkTau", " ", " ", "y", " ", "DescTools::GoodmanKruskalTau", "[0,1]",
  "tbl_uncertainty", " ",  "y", " ", " ", "DescTools::UncertCoef", "[0,1]",
  "tbl_chi", " ",  "y", " ", " ", "DescTools::ContCoef", "[0,1]"
)

kableExtra::kbl(measures,booktabs = T,caption = "List of the functions available in the package for calculating different association measures along with the packages used for calculation.") %>% kableExtra::kable_styling(latex_options = "scale_down")
```


The functions listed in Table \@ref(tab:association-measures) for calculating association measures provide functionality for handling missing values or `NA` in the dataset. Each of these functions either has a `handle.na` argument or automatically uses pairwise complete observations (depending on the package used for calculation) for taking care of missing values present in the data. In \CRANpkg{corVis}, we do not handle date times, or circular variables (usually time-related). The only association measure which handles circular variables is ace, but we are not so far using this feature. In the bike data, the circular variables are `season`, `month` and `weekday`.

The `tbl_*` functions require a dataset as an input and return a `pairwise` data structure. The output includes the pairs of variables for which the `tbl_*` function is defined, the type of association measure, measure value and the type of variable pair. Our display functions `plot_assoc_matrix` or `plot_assoc_linear` can be used to plot this output in a matrix or linear layout respectively. 


## Calculating association measures for whole dataset

The `calc_assoc` function calculates association measures for every variable pair in a dataset. The variable pairs in the output are unique pairs where `x` $\neq$ `y`. Because of the tidy structure of the output, the data manipulation and visualization tools of \CRANpkg{tidyverse} [@tidyverse] are applicable and useful for further exploration of pairwise associations. The output of `calc_assoc` is a `pairwise` data structure with one measure for each pair of variables in the dataset.

The code snippet below shows the calculation of association measures for a subset of the bike sharing data. We select three numeric (`temp`, `windspeed`, `registered`) and two nominal variables (`weathersit`, `workingday`) from the original dataset to demonstrate the usage of `calc_assoc`. We include all of the function arguments for the below example and describe how these are useful. The inputs such as `by` and `include.overall` will be described in the section [Calculating conditional association].

```{r, calc_assoc1,echo=TRUE}
bike_s <- bike |> 
  dplyr::select(temp, windspeed, registered,weathersit, workingday)
bike_s_assoc <- calc_assoc(d = bike_s,
                           by = NULL,
                           types = default_assoc(),
                           include.overall = NULL,
                           handle.na = TRUE,
                           coerce_types = NULL)
bike_s_assoc
```


`calc_assoc` uses `tbl_*` functions to calculate a measure for every variable pair. The `types` argument is a tibble of the `tbl_*` functions for different types of variable pairs. The default is `default_assoc()` which includes `tbl_cor` if both the variables are numeric and calculate Pearson's correlation, `tbl_gkGamma` if both the variables are ordinal and compute Goodman and Kruskal's gamma and `tbl_cancor` for a factor pair and mixed pair and calculate the canonical correlation. 

```{r, default_assoc,echo=TRUE}
default_measures <- default_assoc()
default_measures
```


The default association measures are updated using the `update_assoc` function. For example, an analyst interested in calculating Spearman's rank correlation for numeric pairs, ace measure for mixed pairs and nmi measure for factor pairs can update these measures as shown in the below code segment.

```{r, update_assoc,echo=TRUE}
updated_assoc <- update_assoc(default_measures,
                              num_pair = "tbl_cor",
                              num_pair_argList = "spearman",
                              mixed_pair = "tbl_ace",
                              factor_pair = "tbl_nmi")
updated_assoc
updated_bike_s_assoc <- calc_assoc(d = bike_s, 
                                 types = updated_assoc)
updated_bike_s_assoc

```


The input `handle.na` for `calc_assoc` manages the `NA` or missing value in the data. The default value is set to `TRUE` for using pairwise complete observations for calculating a measure of association between two variables.

Sometimes an analyst might want to treat a factor as an ordered variable. This will also be useful for pairs of binary variables where it will then be possible to see the direction of association. Alternatively, binary variables are treated as numerical. The input `coerce_types` is used to convert variable types. The code segment below demonstrates how nominal factors can be converted into ordinal.

```{r, coerce_types, echo=TRUE}
bike_s_assoc <- calc_assoc(d = bike_s,
                           by = NULL,
                           types = default_assoc(),
                           include.overall = NULL,
                           handle.na = TRUE,
                           coerce_types = list(ordinal=c("workingday", "weathersit")))
bike_s_assoc
```




## Calculating conditional association measures

The function `calc_assoc` is also used to calculate association measures for all the variable pairs at different levels of a categorical variable. This is useful in exploring the conditional associations and finding out variable pairs showing different associations at different levels of the grouping variable. The function has a `by` argument which is used as the grouping variable and needs to be categorical. The tibble output in the conditional setting has a similar structure as `calc_assoc` with an additional `by` column representing the levels of the categorical variable. The output data structure has a `cond_pairwise` class attribute which is used for displaying conditional measures. The data structure is also suitable for tidy operations with tools available in \CRANpkg{tidyverse} [@tidyverse].

```{r, by,echo=TRUE}
bike_s_assoc_by <- calc_assoc(d = bike_s,
                            by = "workingday",
                            include.overall = TRUE)
bike_s_assoc_by
```

By default, the function `calc_assoc` calculates the association measures for all the variable pairs at different levels of the grouping variable and the pairwise association measures for the ungrouped data (`overall`) when used with the `by` argument. This behavior can be changed by setting the `include.overall` argument to `FALSE`.

```{r, include.overall,echo=TRUE}
bike_s_assoc_by <- calc_assoc(d = bike_s,
                            by = "workingday",
                            include.overall = FALSE)
bike_s_assoc_by
```


## Calculating multiple association measures

The comparison of multiple association measures help discover patterns other than linear. We calculate multiple measures with `calc_assoc_all` function in the package. The function takes a dataset and a vector of measures as input and outputs a tibble structure with multiple measures of association for every variable pair. The data structure has `multi_pairwise` class attribute which is used for plotting multiple measure displays in matrix and linear layouts. The code section below calculates `pearson`, `dcor` and `cancor` measures for the variable pairs in subset of bike sharing data. The pairs for which a measure is not defined is not included in the result.

```{r}
bike_s_assoc_multi <- calc_assoc_all(d = bike_s,
                                   measures = c("pearson",
                                                "dcor",
                                                "cancor"))
bike_s_assoc_multi
```



# corVis: Visualising Association Measures

This section provides a detailed description of the novel displays proposed in the package \CRANpkg{corVis}. These displays show multiple association measures to identify variable pairs with non-linear patterns or pairs of variables showing different patterns at different levels of a grouping variable. The package includes functions `plot_assoc_matrix` and `plot_assoc_linear` to produce these displays in a matrix and linear layout respectively. In addition, the package also provides a function `show_assoc` for a quick graphical overview of the relationship between two variables. It displays a scatterplot for numeric pairs, a bar plot for ordered and factor pairs, and a box plot for mixed variable pairs.

## Matrix Displays

Conventionally, correlations have been displayed using a matrix layout. Matrix displays assist in analysing the multivariate structure between the variables. In \CRANpkg{corVis}, the `plot_assoc_matrix` function constructs a plot in the matrix layout displaying variable associations. 

Careful ordering of matrix displays makes it easier to identify patterns and structures. Some examples include @friendly2002corrgrams who demonstrated ordered correlation displays so that groups of variables with high mutual correlation are easily identified and hurley2004clustering who ordered variables in a scatterplot matrix so that interesting panels were positioned close to the main diagonal. They illustrate how seriation, a term to describe the ordering of objects, is useful to reveal interesting patterns. In \CRANpkg{corVis}, we use seriation methods from \CRANpkg{DendSer} [@DendSer] package to seriate matrix displays. In many of the seriation algorithms for matrix displays, the first step is to produce a dissimilarity or similarity matrix of objects to be clustered. Here, objects are the variables of a dataset. We use the Lazy path length (LPL) cost function proposed in \CRANpkg{DendSer} to obtain an ordering using the dissimilarity matrix of variables. This method is efficient in making interesting pairs more prominent in matrix displays by placing them at the start and top-left position.

We now illustrate the use of the `plot_assoc_matrix` function with `pairwise`, `multi_pairwise` and `cond_pairwise` data structures.

### Association Measures Plot

For an association measure display, we start with calculating the default association measures for the bike sharing data (we drop variables dteday, weekday, atemp and cnt) using `calc_assoc` and then plot the `pairwise` output using `plot_assoc_matrix` in a matrix layout. 

```{r assoc-matrix-bike,fig.show="hold", out.width="50%", fig.cap="Left: variables in default order of the data; Right: variables ordered by LPL cost function. Association measures displays for bike sharing data showing Pearson's correlation for the numeric pairs, Goodman Kruskal's gamma measure for ordered pairs and canonical correlation for factor pairs and mixed pairs. The off diagonal cells show the measure value for a variable pair using a circle glyph. The color of every circle is mapped with the measure value for the pair and the radius of the circle is mapped to absolute measure value for the corresponding variable pair. It is easier to identify pairs on the right-hand plot with strong association, for example (casual, temp), (registered,yr) and (weathersit,hum). Also, there is a negative association for (windspeed,registered) suggesting the number of registered users decreased during windy days.",echo=TRUE}

bike$dteday <- NULL 
bike$weekday <- NULL
bike$atemp <- NULL
bike$cnt <- NULL

bike_assoc <- calc_assoc(d = bike)
plot_assoc_matrix(lassoc = bike_assoc,var_order = names(bike)) #default ordering
plot_assoc_matrix(lassoc = bike_assoc, var_order = "default") # DendSer ordering
```

The argument `var_order` is used for ordering the variables. For ordering `pairwise` object, a dissimilarity matrix is constructed first where the dissimilarity is measured by $-|m_{ij}|$, where $m_{ij}$ is the association measure value for a variable pair $(i,j)$. This is followed by hierarchical clustering using the seriation weights (similar to the dissimilarity measure), which produces an order such that the LPL cost function is minimised. A user can also supply their own ordering perhaps obtained from other algorithms by specifying the `var_order` argument.

Figure \@ref(fig:assoc-matrix-bike) compares the default ordering of the variables in the dataset with ordering obtained by seriation using LPL cost function. The plot shows Pearson's correlation for the numeric pairs, Goodman Kruskal's gamma measure for ordered pairs and canonical correlation for factor pairs and mixed pairs. The plot on the right shows highly associated variables at the top left corner or along the diagonal of the display, making it easier for an analyst to identify associated pairs instantly. 

The diagonal cells represent the variables present in the data. Every off diagonal cell contains a glyph, circle in this plot, which is filled with a divergent color scale representing the value of corresponding association measure for a variable pair. The `glyph` argument can be either `circle` or `square` and is only used for object with `pairwise` class. The radius of the circle is mapped to absolute value of the association measure. The argument `limits` specify the range of measure values to be mapped to colors. The default value is in the range $[-1,1]$.

Figure \@ref(fig:assoc-matrix-bike) presents the novel feature of our display showing all the variables of a dataset in the same plot compared to corrgram which only shows association between numeric pairs. With canonical correlation as association measure for factor pairs or mixed pairs, we can observe from Figure \@ref(fig:assoc-matrix-bike) that pairs such as (weathersit, humidity), (workingday, registered), (yr,casual), (season, casual) and (season, registered) are strongly associated.

In some cases, an analyst might want to handle some factors as ordinals to see the direction of association. As discussed in the previous section, we can convert variable types by specifying the `coerce_types` argument. The code below shows an implementation and produces a display with some factor variables as ordinals.

```{r,coerce-types-display, fig.width=3, fig.height=3, fig.align='center', fig.cap="Association matrix display for bike sharing data showing Pearson's correlation for the numeric pairs, Goodman Kruskal's gamma measure for ordered pairs, canonical correlation for factor pairs and mixed pairs. The color of every circle is mapped with the measure value for the pair and the area of the circle is mapped by absolute measure value for the corresponding variable pair. The variables workingday, yr, weathersit and holiday have been converted to ordinals. The plot shows a strong negative association for (workingday, holiday) because no holiday is a working day.",echo=TRUE}
bike_assoc_o <- calc_assoc(bike, 
                           coerce_types=list(ordinal=c("workingday", 
                                                       "yr", 
                                                       "weathersit", 
                                                       "holiday")))

plot_assoc_matrix(bike_assoc_o,
                  glyph="circle")
```

Figure \@ref(fig:coerce-types-display) shows a strong negative association for (workingday, holiday) as holidays are not working days.


We use function `show_assoc` to explore associated variable pairs graphically. Figure \@ref(fig:int-pairs-bike) display scatterplots for pairs (temp,registered) and (windspeed,hum) showing a strong positive and negative trend respectively. The boxplot for pair (workingday,casual) shows a high number of casual users using bikes on days that were not working day. The barplot for variable pair (workingday, holiday) confirms that no working day was a holiday.

```{r int-pairs-bike, fig.show="hold", out.width="50%", fig.cap = "Scatterplots for numeric pair (temp,registered) and (windspeed,hum),  boxplot for mixed pair (workingday,casual) and barplot for ordinal pair ((workingday, holiday) showing association between the pairs of variables.", echo=FALSE}
show_assoc(d = bike, 
           x = "temp", 
           y = "registered")

show_assoc(d = bike, 
           x = "windspeed", 
           y = "hum")

show_assoc(d = bike, 
           x = "workingday", 
           y = "casual")

show_assoc(d = bike, 
           x = "workingday", 
           y = "holiday")
```


### Multiple Association Measures Plot

The multiple measures plot compares association measures for variable pairs in a dataset. This display is useful in detecting pairs showing non-linear association which then can be explored further in more detail. The first step in producing the display is to calculate multiple pairwise association measures for a dataset using the `calc_assoc_all` function. The `multi_pairwise` output of the function is then fed into `plot_assoc_matrix` to produce a multiple measures display. The `plot_assoc_matrix` function constructs a matrix display where the diagonal cells represent the variables and off-diagonal cells show variable pairs with multiple association measures as lollipops. The height and colour of the lollipops are mapped with the absolute value and by the type of association measure.

For the seriation of this display, a similarity matrix is first obtained by taking the maximum association measure value for a variable pair. This is followed by steps similar to the seriation of the matrix display discussed above. We also order multiple measure types in each cell of the multiple measures display. We use a simple sorting approach by ordering the measure types in decreasing order of their average measure value. This locates measure types with high average values at the start of each cell.

Figure \@ref(fig:compare-matrix) shows a multiple association measures plot in matrix layout for bike sharing dataset. We convert the factor variable `mnth` into numeric and use only numeric variables to produce the display. The plot compares the absolute values of association measures such as `ace`, `cancor`, `dcor`, `kendall`, `mic`, `nmi`, `pearson` and `spearman` for every variable pair in the dataset.   

```{r compare-matrix,fig.width=4, fig.height=4.5, fig.align='center',fig.cap="Seriated multiple association measures plot in a matrix layout for numeric variables in bike sharing data. The lollipops in each cell represent the value of the association measure colored by the type of measure. The variable pairs are ordered by the maximum value of association measures such that cells with highest value for any measure are close to the diagonal. The plot shows that pairs (casual,mnth) and (mnth,temp) might have a non-linear association which can be explored further.",echo=TRUE}
biken <- bike |>
  mutate(mnth=as.numeric(mnth)) |>
  select(where(is.numeric))

biken_assoc_all <-calc_assoc_all(biken)
plot_assoc_matrix(biken_assoc_all) 
```

It is evident from the Figure \@ref(fig:compare-matrix) that pairs (casual,mnth) and (mnth,temp) have higher value for `ace` compared to other measures. The measures `nmi`, `dcor` and `mic` have similar values but higher than `pearson`, `spearman` and `kendall`. This suggests the presence of a non-linear pattern for these pairs. 

We use `show_assoc` to explore the pattern for these variable pairs in Figure \@ref(fig:int-pairs-multiple). It is evident from the scatterplots that both (casual,mnth) and (mnth,temp) show a non-linear relationship which measures such as Pearson, Kendall or Spearman correlation failed to capture. The `ace` measure detects this non-linear association efficiently as the `ace` algorithm estimates the transformations of variables which leads to maximal correlation for the variable pair and uncovers non-linear pattern.

```{r int-pairs-multiple, fig.show="hold", out.width="50%", fig.cap = "Scatterplot for variable pairs (from left to right) (casual,mnth) and (mnth,temp) showing a non-linear relationship for these pairs.",echo=FALSE}

show_assoc(biken, "mnth", "casual")
show_assoc(biken, "mnth", "temp")
```



<!-- The function `plot_assoc_linear` is used to display Figure \@ref(fig:compare-linear-heatmap). The function takes tibble of association measures calculated by `calc_assoc_all` as input and outputs a multiple association measures plot in linear layout. `group_var` argument is set to `measure_type` for a multiple measures plot. A maximum difference ordering is used for the plot by setting the `var_order` argument to `max_diff`. The `plot_type` argument is used for the type of plot for plotting the association measures. It is set to `heatmap` for rendering the color intensity to measure value or `dotplot` when points are used to represent the measure value. The `limits` argument is set to `c(0,1)` for multiple measures plot. -->


### Conditional Association Measures Plot

The conditional association measures plot explores bivariate association at different levels of a categorical variable. This display is useful for identifying pairs of variables showing different patterns at different levels of a grouping variable. To produce this display, the first step is to calculate association measures for the variable pairs using `calc_assoc` function at each level of the grouping variable which is specified using the `by` argument. The `cond_pairwise` output is then used as input to `plot_assoc_matrix` to produce a conditional measures display.

When supplied with `cond_pairwise` object, the `plot_assoc_matrix` function constructs a conditional association measures display where the diagonal cells represent the variables and off-diagonal cells show variable pairs with association measures as lollipops for levels of a conditioning variable. The height and colour of the lollipops are mapped with the value of association measure and level of the conditioning variable respectively. The overall value of the association measure for the corresponding pair of variable in a cell is represented by a pink horizontal line.

For ordering the variables, we use a similar strategy as discussed above for matrix displays. The only difference is that a similarity matrix is constructed by taking the range of association measure values at different levels of the conditioning variable for a variable pair. For ordering levels of the conditioning variable in a cell, we follow a similar approach used for ordering measure types in multiple measures display. 

Figure \@ref(fig:cond-assoc) shows a conditional association plot for the bike sharing data in matrix layout. Each cell corresponding to a variable pair shows four lollipops which correspond to the association measure (Pearson's correlation for numeric pairs, Goodman and Kruskal's gamma for ordinal pair, canonical correlation for nominal or mixed pairs) calculated at the levels of conditioning variable `season`. The horizontal pink line represents the overall association measure for the pair. The plot shows a low overall correlation between hum and temp. This is also true in Spring and Winter, but the association is positive in fall and negative in Summer. Also, the overall correlation between registered and temp is moderate and positive. This is also true in each season except for summer where the correlation is about 0. The same pattern also holds for casual. 

```{r cond-assoc,fig.width=4.5, fig.height=4.5, fig.align='center', fig.cap="Seriated conditional association measures plot for bike sharing data showing Pearson's correlation for numeric pairs, Goodman and Kruskal's gamma for ordinal pair, canonical correlation for factor or mixed pairs. The lollipops in each cell represent the value for asssociation measure colored by the conditioning variable season. The pink horizontal line in each cell represents overall value of the association measure. The plot shows evident difference in measure value for pairs (temp, hum), (temp, registered), (temp, casual) and (registered, casual) for different seasons.",echo=TRUE}

bike_by_assoc <- select(bike, -workingday, -holiday, -mnth, -yr) |>
  calc_assoc(by="season", 
                  coerce_types=list(ordinal=c( "weathersit")))


plot_assoc_matrix(bike_by_assoc)
```

We explore these variable pairs in more detail using `show_assoc`. Figure \@ref(fig:int-pairs-conditional) shows scatterplots for variable pairs (temp, hum), (temp, registered), (temp, casual) and (registered, casual) faceted by conditioning variable season. The faceted scatterplot for (temp, hum) show the decrease in humidity with increase in temperature in Summer and the oppsoite during Fall. Clearly, the plot for (temp, registered) and (temp, casual) show that there is no clear pattern for registered and casual with temperature in Summer compared to other seasons.

```{r  int-pairs-conditional, fig.show="hold", out.width="50%", fig.cap = "Scatterplots for variable pairs (temp, hum), (temp, registered), (temp, casual) and (registered, casual) faceted by conditioning variable season", echo=FALSE}

show_assoc(bike, "temp", "hum", by="season")

show_assoc(bike, "temp", "registered", by="season")

show_assoc(bike, "temp", "casual", by="season")

show_assoc(bike, "registered", "casual", by="season")
```


## Linear Displays


We provide linear displays in the form of dot plots or heatmaps for plotting association measures and conditional association measures in `corVis`. These displays are handy for focusing on pairs of variables showing non-negligible associations. In \CRANpkg{corVis}, the `plot_assoc_linear` function constructs a plot in the linear layout displaying variable associations. The only required input for the `plot_assoc_linear` function is a data structure of class `pairwise`, `multi_pairwise` or `cond_pairwise`. We also provide importance sorting for these displays where the items ordered are variable pairs. We sort the variable pairs in decreasing order by either the maximum or the range between the measures for each pair.


Figure \@ref(fig:linear-cond-assoc) shows a linear display for a `cond_pairwise` data structure. The measures are displayed using dotplot (or a heatmap) where color of the dots (or each cell) is coded by the level of the partitioning variable. The plot shows filtered variable pairs having a difference in measure values equal to or greater than 0.25. It also shows Pearson's correlation for numeric pairs, Goodman and Kruskal's gamma for ordinal pairs and canonical correlation for factor or mixed pairs.

For ordering variable pairs of `cond_pairwise` objects, we use the range of measures. The pairs of variables are ordered in descending order by range. As a result of this ordering, the variable pairs with the highest difference in measures are placed on the top of the display. This makes it easier to find triples of variables showing an interesting pattern. The pair of variables for which the measures at different levels are similar show that there is no effect of conditioning on their association.

Figure \@ref(fig:linear-cond-assoc) shows that the variable pair (`hum`, `temp`) is placed at the top of the display and has the highest difference between the measures at different levels of `season`. The two variables humidity and temperature show opposite trends for the summer and fall seasons. This is expected as humidity generally decreases with temperature in summer whereas it tends to increase with temperature during the fall season. 

```{r linear-cond-assoc,fig.width=5, fig.height=4, fig.align='left', fig.cap="Conditional association measures plot for bike sharing data in linear layout.The display has variable pairs on the Y-axis and the value of association measures on the X-axis. The points corresponding to every variable pair represents the value of association measure for different levels of the conditioning variable and the overall value of association measure.",echo=TRUE}

bike_by_assoc <- select(bike, -workingday, -holiday, -mnth, -yr) |>
  calc_assoc(by="season", 
             coerce_types=list(ordinal=c( "weathersit")),
             include.overall = F)

bike_by_assoc |> 
  group_by(x,y) |> 
  summarise(range=max(measure,na.rm = T)-min(measure,na.rm = T)) |> 
  arrange(desc(range)) -> bike_by_assoc_rng
bike_by_assoc_rngf <- filter(bike_by_assoc_rng,range>=0.25) # filtering variable pairs with a range of 0.25 or greater
bike_by_assoc_mod <- filter(bike_by_assoc,
                          x %in% bike_by_assoc_rngf$x & y %in% bike_by_assoc_rngf$y)
plot_assoc_linear(bike_by_assoc_mod, 
                  plot_type = "dotplot",
                  pair_order = "max-min",
                  limits = c(-0.5,1))

```

# Discussion


We use multiple association measures in a single display for different variable pairs which serves as a comparison tool while exploring association in a dataset and assist in identifying unusual variable pairs. These multiple measures can be displayed in a scatterplot matrix similar to what @tukey1985computer proposed. They suggested that scatterplot matrix of the scagnostics measures, which are measures summarizing a scatterplot, can be used to identify unusual scatterplots or variable pairs. @wilkinson2005graph used this idea with their graph-theoretic scagnostic measures to highlight unusual scatterplots. Similarly, @kuhn2013applied have used this idea in a predictive modeling context. They have produced a scatterplot matrix of the measures between the response and continuous predictors such as Pearson's correlation coefficient, pseudo-$R^2$ from the locally weighted regression model, MIC and Spearman's rank correlation coefficient to explore the predictor importance during feature selection step. These displays show the importance of comparing multiple association measures at once for different variable pairs. 
