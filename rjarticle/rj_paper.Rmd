---
title: "corVis: An R Package for Visualising Associations and Conditional Associations"
abstract: >
  Correlation matrix displays are important tools to explore multivariate datasets prior to modeling. These displays with other measures of association can summarize interesting patterns to an analyst and assist them in framing right questions while performing exploratory data analysis. In this paper, we present new visualisation techniques to visualise association between all the variable pairs in a dataset in a single plot, which is something existing displays lack. We extend these displays to regression and classification settings, where these could be used to find out variables with high predictive power. Also, we propse new methods to visualise trivariate relationship summaries using conditioning. We use different layouts like: matrix or linear, to name a few, for our displays which have their own advantages and disadvantages. We use seriation in our displays which helps in highlighting interesting patterns easily. The R package \emph{corVis} provides an implementation.
draft: true
author:  
  
  - name: Amit Chinwan
    affiliation: Maynooth University
    address:
    - Hamilton Institute
    - Maynooth, Ireland
    email:  amit.chinwan.2019@mumail.ie
  - name: Catherine Hurley
    email: catherine.hurley@mu.ie
    affiliation: Maynooth University
    address:
    - Department of Mathematics and Statistics
    - Maynooth, Ireland
type: package
output: 
  rjtools::rjournal_web_article:
    self_contained: yes
    toc: no
bibliography: RJreferences.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(corVis)
library(palmerpenguins)
library(ggplot2)
library(dplyr)
```

# Section 1: Introduction

Exploratory Data Analysis (EDA) is an important step to explore multivariate datasets prior to modeling. One of the important tools used for EDA is correlation matrix display, also known as _corrgram_ [@friendly2002corrgrams]. This display is produced by first calculating the correlation and then plotting these calculated values in a matrix display. The display is useful to quickly find highly associated variables which are explored further and are taken into consideration during the modeling step. Figure \@ref(fig:corrgram) shows the _corrgram_ for the `penguins` dataset from the \CRANpkg{palmerpenguins} package where the diagonal cells have the variable names of the numeric variables in the dataset and the non-diagnonal cell corresponding to a variable pair is colored by the value of Pearson's correlation coefficient between the two variables. It seems that there is a strong positive correlation between `flipper_length_mm` and `body_mass_g`, and a strong negative correlation between `bill_depth_mm` and `flipper_length_mm` of the penguins suggesting a linear trend for these two variable pairs.

```{r corrgram,fig.width=3, fig.height=3, fig.align='center', fig.cap="Example correlation matrix display for penguins data",echo=FALSE}
df <- penguins
assoc <- tbl_cor(df)
association_heatmap(assoc)
```

The correlation matrix displays are generally used with one of the Pearson's, Spearman's or Kendall's correlation coefficient and are therefore limited to numeric variables. In this paper, we propose extensions of these displays and new visualizations which look at multiple association measures, variables of mixed type, and conditional associations. 

The new visualizations look at multiple association measures for every pair of variables in the data and assist an analyst to discover interesting variable pairs.These displays are useful for all the variable types, which is something existing methods lack. The presented conditional association display is produced by plotting association display at different levels of a factor variable, which helps to find interesting patterns. The paper is organised in the following way: first a review of existing packages/methods to calculate and display association with a quick overiew of some association measures used in the package, then our approach to calculate, visualize and order associations in the package, followed by a discussion.


# Section 2: Background

The correlation matrix display is an important tool to explore association among variables in a multivariate analysis. It was first introduced by @murdoch1996graphical in which they replaced the numerical entries of a correlation matrix with ellipses and then popularized by [@friendly2002corrgrams] who called them _corrgrams_, wherein he rendered the correlation values with shaded squares, bars, ellipses, or circular ‘pac-man’ symbols. The main goal of these displays is to describe the bivariate patterns in a dataset. This section provides a brief review of correlation displays and the association measures which are used to explore interesting relationships.

## Section 2.1: Literature Review on Correlation Displays

There are packages available in R which can be used to create correlation matrix displays. The R package \CRANpkg{corrgram} provides these displays with shaded squares, bars, ellipses, or circular ‘pac-man’ glyphs. The package includes various variable ordering methods which assist in detecting patterns of relations among the variables. The package \CRANpkg{corrr} produces correlation matrix in a `tidy` structure, which then can be used to create correlation displays. In addition to matrix display, the package also plots the correlation values in a network display which is useful when dealing with high-dimensional datasets. There have been other extensions to correlation displays like: [@buja2016visualization] and \CRANpkg{sCorrPlot}, which have been proposed mainly for exploring correlations among the numeric variables for a high dimensional dataset. We introduce a display which includes all the variables of a dataset, irrespective of the data type, displaying  every pairwise association. This saves the effort and time of an analyst for exploring relationship among all the variable pairs. @kuhn2013applied have proposed display techniques to compare multiple association measures for every pair of output variable and a predictor to measure the importance of each predictor. This can help in summarizing a complex relationship more efficiently as compared to using just one measure like Pearson's correlation which can only find linear associations. In a similar way, we propose different visualization techniques to compare multiple association measures for all the variable pairs in a dataset which can assist a user in finding interesting patterns.

## Section 2.2: Literature Review on Association Measures

An association measure can be defined as a numerical summary quantifying relationship between two or more variables. For example, Pearson's correlation coefficient summarizes the strength and direction of the linear relationship present between two \emph{numeric} variables and is in the range $[-1,1]$. Similarly, distance correlation coefficient measures the non-linear association between two \emph{numeric} variables and summarizes it in $[0,1]$ where $0$ suggests no non-linear relationship and $1$ suggests very high non-linear relationship. The package provides a collection of various measures of association which can be used to quantify the relationship between two variables and could be used to explore patterns prior to modeling. The measures available in the package are not limited to \emph{numeric} variables only and can be used with \emph{categorical} and \emph{ordinal} variables as well.
\begin{itemize}
\item Pearson's correlation
\item Spearman's rank correlation.
\item Kendall's rank correlation.
\item Distance correlation.
\item Canonical correlations.
\item Maximal-information based non-parametric exploration (MINE) statistics.
\end{itemize}

The package provides a collection of various measures of association which is used to quantify the relationship between two variables and is used to explore patterns prior to modeling. The measures available in the package are not limited to *numeric* variables and are used with *categorical* and *ordinal* variables as well. Table \@ref(tab:association_measures) lists the different measures of association provided in the package with the variable types they can be used with, the package used for calculation, the information on whether the measure is symmetric, and the minimum and maximum value of the measure. 
```{r association_measures,echo=FALSE}
assocMethods <- tribble(
  ~funName, ~typeX, ~typeY,  ~from, ~symmetric, ~min, ~max,
  "tbl_cor", "numeric", "numeric",  "stats::cor", TRUE, -1,1,
  "tbl_dcor", "numeric", "numeric",  "energy::dcor2d", TRUE, 0,1,
  "tbl_mine", "numeric", "numeric", "minerva::mine",TRUE, 0,1,
  "tbl_polycor", "ordinal", "ordinal", "polycor::polychor", TRUE, -1,1,
  "tbl_tau", "ordinal", "ordinal", "DescTools::KendalTauA,B,C,W", TRUE, -1,1,
  "tbl_gkTau", "nominal", "nominal", "DescTools::GoodmanKruskalTau", FALSE, 0,1,
  "tbl_gkLambda", "nominal", "nominal", "DescTools::GoodmanKruskalTau", TRUE, 0,1,
  "tbl_gkGamma", "nominal", "nominal", "DescTools::GoodmanKruskalTau", TRUE, 0,1,
  "tbl_uncertainty", "nominal", "nominal", "DescTools::UncertCoef", TRUE, 0,1,
  "tbl_chi", "nominal", "nominal", "DescTools::ContCoef", TRUE, 0,1,
  "tbl_cancor", "nominal", "nominal", "corVis", TRUE, 0,1,
  "tbl_cancor", "nominal", "numerical", "corVis", TRUE, 0,1,
  "tbl_nmi", "any", "any", "corVis", TRUE, 0,1,
  "tbl_easy", "any", "any", "correlation::correlation", TRUE, -1, 1)

kableExtra::kbl(assocMethods, booktabs = T)
#kableExtra::kable_styling(kable_input,latex_options = "striped")
#knitr::kable(assocMethods)
```

# Section 3: corVis Package


## Section 3.1: Calculating Association

We introduce a method which creates a tibble structure for the variable pairs in a dataset along with calculated association measure. The package contains various functions (shown in Table 1) for different association measures in the form `tbl_*` to calculate them. For example, a user might be interested in calculating distance correlation for numeric pair of variables in a dataset. This can be done by using `tbl_dcor`. 

```{r,echo=TRUE}
df <- penguins
distance <- tbl_dcor(df)
head(distance)
```

Similarly, one can use `tbl_nmi` to calculate normalised mutual information for numeric, nominal and mixed pair of variables.
```{r,echo=TRUE}
nmi <- tbl_nmi(df)
head(nmi)
```

These functions return a tibble with the variable pairs and calculated measure, and also with additional classes `pairwise` and `data.frame`. With the pairwise measures of association in a tibble or dataframe structure, the output of these functions can then be used with packages like `dplyr` , `ggplot2` for further exploration of association measures. 

```{r,echo=TRUE}
class(distance)
```

The function `matrix_assoc` helps in converting the tibble of association measure to matrix structure. The function takes a tibble or dataframe of the variable pairs of the dataset along with the calculated association measures and returns a symmetric matrix of the variables.
```{r,echo=TRUE}
head(matrix_assoc(distance))
```
The function outputs a matrix even if any variable pair is missing in the input tibble with  `NA` for corresponding variable pair cell in the matrix output.
```{r,echo=TRUE}
distance <- distance[-1,]
matrix_assoc(distance)
```

The function has an additional argument called `group` which represents the level of the grouping categorical variable for which the matrix output needs to be calculated and is set to `overall` as default. 


### Calculating association measures for whole dataset

`calc_assoc` can be used to calculate association measures for all the variable pairs in the dataset at once in a tibble structure. In addition to tibble structure, the output also has `paiwise` and `data.frame` class which are important class attributes for producing visual summaries in this package. 

```{r,echo=TRUE}
complete_assoc <- calc_assoc(df)
glimpse(complete_assoc)
class(complete_assoc)
```

The function has a *types* argument which is basically a tibble of the association measure to be calculated for different variable pairs. The default tibble of measures is `default_assoc()` which calculates Pearson's correlation if both the variables are numeric, Kendall's tau-b if both the variables are ordinal, canonical correlation if one is factor and other is numeric and canonical correlation for the rest of the variable pairs. 

```{r,echo=TRUE}
default_measures <- update_assoc()
default_measures
```


An analyst can update these measures using the `update_assoc` function where one can specify a `tbl_*` function to calculate association measure depending on the variable pair in the dataset and a method if it calculates more than one measure.

```{r,echo=TRUE}
updated_assoc <- update_assoc(num_pair = "tbl_cor",
                              num_pair_argList = "spearman",
                              mixed_pair = "tbl_cancor",
                              other_pair = "tbl_nmi")
updated_assoc

updated_complete_assoc <- calc_assoc(df, types = updated_assoc)
head(updated_complete_assoc)
```

The tibble output for `calc_assoc` has the following structure:

  - `x` and `y` representing a pair of variables
  - `measure` representing the calculated value for association measure
  - `measure_type` representing the association measure calculated for `x` and `y` pair.
  
The variable pairs in the output are unique pairs and a subset of all the variable pairs of a dataset where `x` $\neq$ `y`. As explained earlier, the `measure_type` represents the association measure calculated for a specific type of variable pair. A user can be interested in calculating multiple association measures for a type of variable pair. This can be done by using the `calc_assoc` and `update_assoc` together for calculating different association measures and then merging the output tibbles. 

### Calculating conditional association

`calc_assoc_by` can be used to calculate association measures for all the variable pairs at different levels of a categorical variable. This can help in exploring the conditional associations and find out interesting patterns in the data prior to modeling. The output of this function is a tibble structure with `pairwise` and `data.frame` as additional class attributes. The `by` argument is used for the grouping variable which needs to be categorical. 
```{r,echo=TRUE}
complete_assoc_by <- calc_assoc_by(df,by = "sex")
```

The function also has a `types` argument which can be updated similarly to `calc_assoc`. 
```{r,echo=TRUE}
updated_assoc <- update_assoc(num_pair = "tbl_cor",
                              num_pair_argList = "spearman",
                              mixed_pair = "tbl_cancor",
                              other_pair = "tbl_nmi")
updated_complete_assoc_by <- calc_assoc_by(df,by = "sex", types = updated_assoc)
head(updated_complete_assoc_by)
```

By default, the function calculates the association measures for all the variable pairs at different levels of the grouping variable and the pairwise association measures for the ungrouped data (*overall*). This behavior can be changed by setting `include.overall` to *FALSE*.

```{r,echo=TRUE}
complete_assoc_by <- calc_assoc_by(df,by = "sex",include.overall = FALSE)
```

The tibble output for `calc_assoc_by` has the following structure:

  - `x` and `y` representing a pair of variables
  - `measure` representing the calculated value for association measure
  - `measure_type` representing the association measure calculated for `x` and `y` pair.
  - `by` representing the levels of the categorical variable used in the function. 
 
The variable pairs in the output are repeated for every level of `by` variable. At present the function doesn't allow multiple `by` variables to be used for conditioning but is something which can be done by using the `calc_assoc_by` function multiple times and then merging the multiple outputs.For calculating multiple measures for a specific variable type, one can use `update_assoc` with `calc_assoc_by` and then can merge these multiple tibble outputs.

### Creating Your Own Association Measure

We introduce a new structure for calculating association measures which can be used to add other existing or new measures in the package. These measures can then then be analysed and visualised using the plot functions present in the package. For example, Cramer's V is a measure to summarize association between two categorical variables using the Chi-square test statistic. If a user wants to add Cramer's V to the package, they can write a simple function and then can use it for their analysis.



## Section 3.2: Visualising Association

We propose novel visualisations to display association for every variable pair in a dataset in a single plot and show multiple bivariate measures of association simultaneously to find out interesting patterns. Efficient seriation techniques have been included to order and highlight interesting relationships. These ordered association and conditional association displays can help find interesting patterns in the dataset. While designing these displays we considered matrix-type, linear and network-based layouts. A matrix-type layout simplifies lookup, and different measures may be displayed on the upper and lower diagonal. Linear layouts are more space-efficient than matrix plots, but lookup is more challenging. Variable pairs can be ordered by relevance (usually difference in measures of association or across the factor levels), and less relevant pairs can be omitted. Linear displays are also suitable to display associations between the response and predictors only. Our selection criteria for a better display were based on :
\begin{itemize}
\item Number of variables
\item Easier pixel-variable or variable-pixel
look up
\item Number of levels of a factor for conditional association displays
\end{itemize}



Figure \@ref(fig:assoc-heatmap) shows this display for every variable pair in the *penguins* dataset from the *palmerpenguins* package. It shows a high positive Pearson's correlation among flipper_length_mm and body_mass_g, flipper_length_mm and bill_length_mm, and bill_length_mm and bodymass_g. There seems to be a strong negative Pearson's correlation between flipper_length_mm and bill_depth_mm, and bill_depth_mm and body_mass_g. The plot also shows that there is a high canonical correlation between species and other variables except year and sex, and a high canonical correlation between island and species, which traditional correlation matrix display would omit as they are limited to numeric variable pairs only. The variables in the display are ordered using average linkage clustering method to find out highly associated variables quickly.

```{r assoc-heatmap,fig.width=4, fig.height=4, fig.align='center', fig.cap="Association matrix display for penguins data"}
df <- penguins
assoc <- calc_assoc(df)
association_heatmap(assoc)
```


We can also calculate multiple association measures for all the variable pairs in the dataset and compare them. This will help in finding out pairs of variables with a high difference among different measures and one can investigate these bivariate relationships in more detail. The `pairwise_summary_plot` function can be used to compare various measures using the matrix layout. It plots multiple measures among the variable pairs as bars, where each bar represents one measure of association. Figure \@ref(fig:compare-matrix) shows a matrix layout comparing Pearson's and Spearman's correlation coefficient for the numeric variable pairs in *penguins* data. 

```{r compare-matrix, fig.width=4, fig.height=4, fig.align='center',fig.cap="Comparing Pearson's and Spearman's correlation coefficient"}

df_num <- select(df,where(is.numeric))
pearson <- calc_assoc(df_num)

spearman_assoc <- update_assoc(num_pair = "tbl_cor",
                               num_pair_argList= "spearman",
                               mixed_pair = "tbl_cancor",
                               other_pair = "tbl_nmi")
spearman <- calc_assoc(df_num, types=spearman_assoc)
compare <- rbind(pearson,spearman)
pairwise_summary_plot(compare, group_var = "measure_type")
```

In addition to matrix layout, we can also use linear layouts for comparing multiple measures. Figure \@ref(fig:compare-linear) shows a linear layout comparing multiple association measures for all the variable pairs in the penguins data.  Linear layouts seems to be more suitable when comparing high number of association measures.   

```{r compare-linear,fig.width=4, fig.height=4, fig.align='center',fig.cap="Comparing multiple association measures using a linear layout"}


pairwise_measures_compare(df,measures=c("pearson","spearman","kendall","cancor","nmi"))

```



### Visualising Conditional Association

The package includes a function `calc_assoc_by` which calculates the pairwise association at different levels of a categorical conditioning variable. This helps in finding out interesting variable triples which can be explored further prior to modeling. Figure \@ref(fig:cond-assoc) shows a conditional association plot for the *penguins* data. Each cell corresponding to a variable pair shows three bars which correspond to the association measure (Pearson's correlation for numeric pair and Normalized mutual information for other combination of variables) calculated at the levels of conditioning variable *island*. The dashed line represents the overall association measure. The plot shows that there is a high value for normalised mutual information between bill_length_mm and species for the penguins which lived in *Biscoe* island compared to the penguins which lived in *Dream* island. It can also be seen that the cell corresponding to variable pair flipper_length_mm and bill_depth_mm has a high negative overall Pearson's correlation and for the penguins which lived in *Biscoe* island but positive  correlation for penguins which lived in *Dream* and *Torgersen* island. This is an instance of Simpson's paradox which can be taken into account during the modeling step.


```{r cond-assoc,fig.width=4, fig.height=4, fig.align='center', fig.cap="Conditional Association plot"}
updated_assoc <- update_assoc(num_pair = "tbl_cor",
                              mixed_pair = "tbl_nmi",
                              other_pair = "tbl_nmi")

cond_assoc <- calc_assoc_by(df, by="island")
pairwise_summary_plot(cond_assoc)
```

We also provide a functionality for highlighting interesting patterns like Simpson's paradox. Figure 5 shows the matrix plot with highlighted cells for the variable pairs where Simpson's paradox is present.

```{r,fig.width=4, fig.height=4, fig.align='center',fig.cap="Conditional Association plot with Simpson's paradox"}
pairwise_summary_plot_sp_high(cond_assoc,highlight = "sp")
```

The cells can also be highlighted on the basis of a score calculated by the user. This can be done by providing a dataframe with pairs of variables to highlight and a score for highlighting variable pairs. The cells with high score will have a thicker border compared to cells with low score. Figure 6 shows highlighted cells on the basis of a score provided for a subset of variable pairs.

```{r,fig.width=4, fig.height=4, fig.align='center',fig.cap="Conditional Association plot with manual highlighting"}
highlight <- data.frame(x=c("bill_depth_mm","bill_length_mm","body_mass_g"),
                        y=rep("flipper_length_mm",3),score=c(0.8,0.4,0.1))
pairwise_summary_plot_sp_high(cond_assoc,highlight = highlight)
```



We can also use linear layouts for displaying conditional association. Figure 7 shows a funnel-like linear display for conditional association measures with all the variable pairs on the y-axis, the value of association measure on x-axis and color of the points representing the level of the grouping variable. The linear layout becomes more useful over the matrix layout when the number of variables and number of levels of grouping variable are high.

```{r linear_cond_assoc, fig.width=4, fig.height=5, fig.align='center', fig.cap="Conditional Association plot using linear layout"}

pairwise_linear_plot(cond_assoc)
```

## Section 3.3: Seriation



# Section 4: Discussion


