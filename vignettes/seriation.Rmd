---
title: "Seriation in corVis"
author: "Amit Chinwan and Catherine Hurley"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
     toc: true
vignette: >
  %\VignetteIndexEntry{Seriation in corVis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r global options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,echo=FALSE,fig.height = 5, fig.width = 5,
                      fig.align = 'left')
```

Careful ordering of graphical displays makes it easier to identify patterns and structures. An example of simple graphical sorting is a barplot for Covid deaths in different countries arranged in descending order compared to the alphabetical order of the countries. Other complex ordering examples include Friendly (2002) who demonstrated ordered correlation displays so that groups of variables with high mutual correlation are easily identified and Hurley (2004) who ordered variables in a scatterplot matrix so that interesting panels were positioned close to the main diagonal. All the above cases illustrate how seriation, a term to describe ordering of objects, is useful to reveal interesting patterns. This vignette focuses on the seriation techniques used for linear and matrix displays in `corVis`.


```{r, setup}
if (!requireNamespace("openintro", quietly = TRUE))
  install.packages("openintro")

library(corVis)
library(openintro)
library(dplyr)
library(kableExtra)
library(ggplot2)


```

## Linear displays

We provide linear displays in the form of dot plots or heatmaps for plotting association measures and conditional association measures in `corVis`. In these displays, the items ordered are variable pairs. We use two basic sorting techniques to seriate the variable pairs in these displays.

The first technique involves using the maximum absolute value for ordering the variable pairs. In the case of multiple measures and conditional measures display, the variable pairs are ordered in descending order by the maximum absolute measure value of the available measures for each pair. This produces a display with highly associated variable pairs at the top, simplifying the task to identify associated variables.

Figure 1 shows the seriated conditional measure linear display for `acs12` (American Community Survey) data where it is easier to find highly associated variable pairs in the plot compared to a plot with default variable pairs ordering. The variable pairs (`lang`, `race`) and (`age`, `emp`) are placed at the top of the display and are strongly associated for indviduals with `grad` level education. The `NA` level for the grouping variable `edu` shows that education was missing for some individuals in the survey. Looking at the dataset more closely, it is found that these individuals haven't started school yet.  The variable pair (`time_w`,`emp`) at the bottom of the plot shows no calculated measure for any level of `edu`. This is because, at different levels of `edu`, the complete cases for this pair contain only one level for the `emp` variable and the calculated canonical correlation measure is undefined.

```{r linear_cond_max,echo=TRUE, fig.height=6,fig.cap="Figure 1: Conditional association measure display in linear layout with variable pair ordered by maximum absolute measure value at each level"}
df <- openintro::acs12
names(df) # variable names

names(df) <- c("inc", "emp", "hrs_w", "race", "age", "gen", "citz", "time_w", "lang",
               "marr", "edu", "dis","birt_q") # shortening the variable names
cond_assoc <- calc_assoc(df, by = "edu", include.overall = F)

plot_assoc_linear(cond_assoc, plot_type = "dotplot",limits = c(-0.5,1))
filter(df,is.na(edu)) |> pull(age) |> range() # age of individuals with missing education
```


The second technique uses the range of measures to order variable pairs. The pairs of variables are ordered in descending order by range. As a result of this ordering, the variable pairs with the highest range are placed on the top of the display, making it easier for an analyst to find variable pairs with a high difference.

Figure 2 shows a seriated linear display using the range technique. It is easier to spot the variable pairs with high differences among association measures at different levels of conditioning variable in the plot. The variable pairs (`birth_q`, `race`) and (`marr`, `age`) are placed at the top of the display and have highest difference among the measures.
```{r linear_cond_max_diff,echo=TRUE,fig.height=6, fig.cap="Figure 2: Conditional association measure display in linear layout with variable pair ordered by maximum difference value at each level"}
plot_assoc_linear(cond_assoc, plot_type = "dotplot",pair_order = "max_diff", limits = c(-0.5,1))
```


## Matrix displays

We use methods from `DendSer` package to seriate matrix displays in `corVis`. In many of the seriation algorithms for matrix displays, the first step is to produce a dissimilarity or similarity matrix of objects to be clustered. Here, objects are the variables of a dataset. We use the Lazy path length (LPL) cost function proposed in `DendSer` to obtain an ordering using the dissimilarity matrix of variables. This method provides a form of importance sorting and is efficient in making interesting pairs more prominent in matrix displays by placing them at the start and top-left position.

Below is a code snippet showing how `dser` function from `DendSer` package can be used to obtain an ordering for the correlation matrix of numeric variables in `iris`  data. The dissimilarity between variable pairs is measured by -|Pearson correlation| and a dissimilarity matrix is constructed. 
```{r,echo=TRUE}
iris_n <- dplyr::select(iris,where(is.numeric))
m <- cor(iris_n)
o<-DendSer::dser(as.dist(-abs(m)),cost = DendSer::costLPL)
names(iris_n)[o]
```



Below we provide a general overview of the seriation algorithm presented in `DendSer` and LPL cost function to understand how seriation is implemented. The algorithm uses a seriation weight $w_{ij}$ for variables $i$ and $j$, which measures the importance of a cell, in the matrix and uses these weights to perform hierarchical clustering. Generally, the weights are measures of dissimilarity between the variables. The final step is to rearrange the nodes of the dendrogram obtained from clustering such that ordering minimises a cost function. This produces an arrangement where associated variable pairs are placed adjacent or nearby each other. As people generally read from left to right, placing the most important cells at the beginning or top-left corner of the display allows an analyst to immediately identify important pairs of variables. We use the LPL cost function to achieve this.

Let $\pi$ be an order obtained from the hierarchical clustering of a matrix with n variables using the seriation weights $w_{ij}$. Then, LPL cost function for an order $\pi$ is defined as:

$LPL(\pi) = \sum_{i=1}^{n-1} (n-1) w_{\pi(i),\pi(i+1)}$

LPL is a weighted measure of path length and rewards orders with short path lengths and where the weights generally increase.

<!-- We use seriation algorithm from Earle and Hurley (2015) to achieve this for our displays. The first step is to perform hierarchical clustering of a dissimilarity matrix (either for association measure display, multiple measures display or conditional measure display). This yields a dendrogram with an ordering where highly similar variables, depending on the display, are nearby. When used in a matrix display, this ordering brings similar variables close to the diagonal. In order to put these variables on the top-left corner we need an additional sorting step. This step uses seriation weights $w_{ij}$, where $w_{ij}$ measures the importance of comparison for variables $(i,j)$ and a cost function, where the main goal is to find a dendrogram ordering which minimizes the cost function. The cost function we use in _corVis_ is lazy path length (LPL) which is a variant of travelling salesman problem and rewards a short path with increasing weights.  -->

We use the sorting approach discussed above for all of our matrix displays to obtain variable ordering.

### Association measure display

The association measure display plots a measure of association for variable pairs in a dataset. The plotting function `plot_assoc_matrix` takes a data structure with variable pairs and corresponding measures as input. For ordering the variables, a dissimilarity matrix is constructed first where the dissimilarity is measured by $-|m_{ij}|$, where $m_{ij}$ is the association measure value for a variable pair $(i,j)$. This is followed by hierarchical clustering using the seriation weights (similar to the dissimilarity measure), which produces an order such that the LPL cost function is minimised.  

Figure 3 compares the default ordering of the variables in the dataset with ordering obtained by seriation using LPL cost function. The plot with default ordering uses circular glyph and the seriated plot uses square glyph to show association measure value. The plot on the right shows highly associated variables at the top left corner or along the diagonal of the display, making it easier for an analyst to identify associated pairs instantly. For instance, the variable pairs (`edu`,`inc`) and (`emp`, `dis`) are highly associated and are easy to discover in the plot on right compared to the plot on the left.

```{r assoc_display, fig.show="hold", out.width="45%", echo=TRUE, fig.align='default',fig.cap="Figure 3: Association measure display for `acs12` data. Left: variables in default order of the data; right: variables ordered by LPL cost function"}
assoc <- calc_assoc(df)
plot_assoc_matrix(assoc, var_order = names(df),glyph = "circle")
plot_assoc_matrix(assoc)
```

A user can also supply their own ordering perhaps obtained from other algorithm by specifying `var_order` argument in the `plot_assoc_matrix` function.

### Multiple measures display

The multiple measures display plots multiple measures of association for every variable pair in the dataset. For the seriation of this display, a similarity matrix is first obtained by taking the maximum association measure value for a variable pair. This is followed by steps similar to the seriation of the matrix display discussed above.

We also order multiple measure types in each cell of the multiple measures display. We use a simple sorting approach by ordering the measure types in decreasing order of their average measure value. This locates measure types with high average values at the start of each cell.

Figure 4 shows a seriated multiple measures display. The plot displays variable pairs with high measure value(s) in the top left corner or along the diagonal of the display, making it easier to find pairs of variables where any of the measures is high. The plot shows variable pairs (`hrs_w`, `emp`), (`inc`, `emp`), (`emp`, `age`) and (`age`, `marr`) with a high value for `ace` measure. 

The variable pair (`inc`, `age`) in Figure 4 is also placed close to the diagonal and shows a high value for measure `ace` compared to other measures of association. A closer look at the variable pair using a scatterplot shows the presence of non-linear association which is captured by `ace` measure. 

```{r multi_display, echo=TRUE, fig.align='default',fig.cap="Figure 4: Seriated multiple association measures display for `acs12` data. Variable pairs at top left or along diagonal of the display have a high value for any of the multiple measures.", fig.height=6,fig.width=7}

multi_assoc <- calc_assoc_all(df)

#plot_assoc_matrix(multi_assoc, var_order = names(df))
plot_assoc_matrix(multi_assoc)
```

```{r scatter, fig.cap="Figure 5: Scatterplot for variable pair (`age`, `inc`) showing non-linear pattern"}
# scatterplot for variable pair (`inc`, `age`)
df_mod <- filter(df,inc>0) # removing individuals with 0 income
show_assoc(df_mod,x="age",y="inc")
```


### Conditional association measures display

The conditional association measure display plots pairwise association measures at different levels of a conditioning variable. For ordering the variables, we use a similar strategy as discussed above for matrix displays. The only difference is that a similarity matrix is constructed by taking the range of association measure values at different levels of the conditioning variable for a variable pair.

For ordering levels of the conditioning variable, we follow a similar approach used for ordering measure types in multiple measures display. 

Figure 5 shows the seriated conditional association measure display. The variable pairs with high differences in measure value for a grouping variable are placed at the beginning or along the diagonal of the display. This helps in quickly finding pairs with high group differences. The plot shows variable pairs (`marr`, `age`) and (`age`, `emp`) with high differences in canonical correlation value at different levels of the conditioning variable `edu`.
```{r cond_display, echo=TRUE, fig.align='default', fig.cap="Figure 6: Seriated conditional association measures display for acs12 data. Variable pairs at top left or along diagonal of the display have a high difference in the measures value calculated at different levels of the conditioning variable.", fig.height=6,fig.width=7}
cond_assoc <- calc_assoc(df,by="edu",include.overall = F)
plot_assoc_matrix(cond_assoc)
```




