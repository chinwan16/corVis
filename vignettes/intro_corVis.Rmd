---
title: "Introduction to corVis"
author: "Amit Chinwan and Catherine Hurley"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
     toc: true
vignette: >
  %\VignetteIndexEntry{Introduction to corVis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---



```{r global options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```


```{r}
if (!requireNamespace("NHANES", quietly = TRUE))
  install.packages("NHANES")
library(corVis)
library(NHANES)
library(dplyr)

dim(NHANES)
set.seed(12)
rows <- sample(1:nrow(NHANES),5000)
cols <- sample(1:ncol(NHANES),15)
nhanes_mod <- NHANES[rows,cols]

```

corVis is an R package which calculates measures of association for every variable pair in a dataset and helps in visualising these associations in different ways. The package can also calculate and visualise the pairwise association measures conditionally at different levels of a grouping variable. Efficient seriation techniques have been included to highlight interesting relationships. These ordered assocation and conditional association displays can help find interesting patterns in the dataset.


## Measures of Association

An association measure can be defined as a numerical summary quantifying relationship between two or more variables. For example, Pearson's correlation coefficient summarizes the strength and direction of the linear relationship present between two *numeric* variables and is in the range $[-1,1]$. Similarly, distance correlation coefficient measures the non-linear association between two *numeric* variables and summarizes it in $[0,1]$ where $0$ suggests no non-linear relationship and $1$ suggests very high non-linear relationship.

The package provides a collection of various measures of association which can be used to quantify the relationship between two variables and could be used to explore patterns prior to modeling. The measures available in the package are not limited to *numeric* variables only and can be used with *categorical* and *ordinal* variables as well. Table 1 lists the different measures of association provided in the package with the variable types they can be used with, the package used for calculation, the information on whether the measure is symmetric, and the minimum and maximum value of the measure.
```{r,echo=FALSE}
assocMethods <- tribble(
  ~funName, ~typeX, ~typeY,  ~from, ~symmetric, ~min, ~max,
  "tbl_cor", "numeric", "numeric",  "stats::cor", TRUE, -1,1,
  "tbl_dcor2d", "numeric", "numeric",  "energy::dcor2d", TRUE, 0,1,
  "tbl_mine", "numeric", "numeric", "minerva::mine",TRUE, 0,1,
  # "tbl_hoeffD", "numeric", "numeric", "DescTools::HoeffD",TRUE, -.5,1,
  "tbl_polycor", "ordinal", "ordinal", "polycor::polychor", TRUE, -1,1,
  "tbl_tau", "ordinal", "ordinal", "DescTools::KendalTauA,B,C,W", TRUE, -1,1,
  "tbl_gkTau", "nominal", "nominal", "DescTools::GoodmanKruskalTau", FALSE, 0,1,
  "tbl_gkLambda", "nominal", "nominal", "DescTools::GoodmanKruskalTau", TRUE, 0,1,
  "tbl_gkGamma", "nominal", "nominal", "DescTools::GoodmanKruskalTau", TRUE, 0,1,
  "tbl_uncertainty", "nominal", "nominal", "DescTools::UncertCoef", TRUE, 0,1,
  "tbl_chi", "nominal", "nominal", "DescTools::ContCoef", TRUE, 0,1,
  "tbl_cancor", "nominal", "nominal", "this", TRUE, 0,1,
  "tbl_cancor", "nominal", "numerical", "this", TRUE, 0,1,
  "tbl_easy", "any", "any", "correlation::correlation", TRUE, -1, 1)

knitr::kable(assocMethods)
```
Table 1: Available measures of association in the package


## Data preparation

We introduce a method which creates a tibble or matrix structure for all the variable pairs in a dataset along with calculated association measures. These measures are controlled by the user and depend on the types of variable in the variable pair. For example, a user might be interested in calculating Pearson's correlation for numeric pair of variables and canonical correlation for categorical variable pair or mixed variable pair. The function with `tbl_` calculates the association measure for applicable pairs of variable and report them in a tibble structure. The tibble of measures can be easily converted to a matrix structure by using `matrix_assoc`

```{r}
a <- tbl_cor(nhanes_mod)
glimpse(a)

head(matrix_assoc(a))
```


`calc_assoc` can be used to calculate association measures for all the variable pairs in the dataset. The function has a *types* argument which is basically a tibble of the association measures for different variable types. The default tibble of measures is `default_assoc()` which calculates Pearson's correlation if both the variables are numeric, Kendall's tau-b if both the variables are ordinal, canonical correlation if one is factor and other is numeric and canonical correlation for the rest of the variable pairs. An analyst can update these measures as shown below.

```{r}
default <- default_assoc()
default
glimpse(calc_assoc(nhanes_mod))

#update the measures
spearman_assoc <- default_assoc()
spearman_assoc$argList[[1]] <- list(method="spearman")

glimpse(calc_assoc(nhanes_mod, types=spearman_assoc))

#update the association function
updated_assoc <- write_own_assoc("tbl_dcor",1)
updated_assoc
```




## Visualising Association

After calculating association measures among different variable pairs, these can be visualised using different layouts. Figure 1 shows the famous matrix layout of association measure for every variable pair in the sampled version of *NHANES* dataset. It shows a high positive Pearson's correlation among BPSys1 and BPSysAve, BPSys1 and BPSys3, BPSys3 and BPSysAve and HomeRooms and Poverty. The plot also shows that there is some mutual information between Race3 and UrineVol2 and PhysActive and UrineVol2 which traditional correlation matrix display would omit as they are limited to numeric variable pairs only. 
```{r fig.width=8, fig.height=8, fig.align='center', fig.cap="Figure 1: Association matrix display for iris data"}
assoc <- calc_assoc(nhanes_mod)
assoc_complete <- assoc[complete.cases(assoc),]
association_heatmap(assoc_complete)
```


We can also compare association measures to find out pairs of variables with a high difference and can investigate these bivariate relationships in more detail. The `pairwise_summary_plot` function can be used to compare various measures using the matrix layout. It plots different measures among the variable pairs as bars, where each bar represents one measure of association. Figure 2 shows a matrix layout comparing Pearson's and Spearman's correlation coefficient for the numeric variable pairs in sampled *NHANES* data. It seems that both the coefficients are very similar for every variable pair.
```{r fig.width=8, fig.height=8, fig.align='center',fig.cap="Figure 2: Comparing Pearson's and Spearman's correlation coefficient"}

num_vars <- names(which(sapply(nhanes_mod,is.numeric)))
pearson <- calc_assoc(nhanes_mod[,num_vars])

spearman_assoc <- default_assoc()
spearman_assoc$argList[[1]] <- list(method="spearman")
spearman <- calc_assoc(nhanes_mod[,num_vars], types=spearman_assoc)

pairwise_summary_plot(a <- rbind(pearson,spearman), group_var = "measure_type")
```


We can also use linear layouts for comparing multiple measures (in progress....)


## Visualising Conditional Association


The package includes a function `calc_assoc_by` which calculates the pairwise association at different levels of a categorical conditioning variable. This helps in finding out interesting variable triples which can be explored further prior to modeling. Figure 3 shows a conditional association plot for the sampled *NHANES* data. Each cell corresponding to a variable pair shows two bars which correspond to the association measure (Pearson's correlation for numeric pair and Normalized mutual information for other combination of variables) calculated at the levels of conditioning variable *PhysActive*. The dashed line represents the overall association measure. The plot shows that there is a high positive canonical correlation between nPregnancies and Race3 for individuals who responded *No* for *PhysActive* compared to the individuals who responded *Yes*. It can also be seen that the cell corresponding to variable pair HomeRooms and TotChol has a positive overall correlation but negative and positive correlations at different levels of the conditioning variable. This is an instance of Simpson's paradox which can be taken into account during the modeling step.

We also provide a functionality for highlighting interesting patterns like Simpson's paradox. In the below figure, the highlighted cells indicate the variable pairs where Simpson's paradox is present.
```{r fig.width=8, fig.height=8, fig.align='center', fig.cap="Figure 3: Conditional Association plot"}
nhanes_mod_comp <- nhanes_mod[complete.cases(nhanes_mod),]
cond_assoc <- calc_assoc_by(nhanes_mod_comp, by="PhysActive")
pairwise_summary_plot(cond_assoc)
```


We can also use linear layouts for displaying conditional association. The linear layout becomes more useful over the matrix layout when the number of variables and number of levels of grouping variable are high.

```{r fig.width=6, fig.height=9, fig.align='center', fig.cap="Figure 4: Conditional Association plot using linear layout"}
pairwise_linear_plot(cond_assoc)
```











